#!/usr/bin/env ruby
# Copyright (C) 2014 Continuent, Inc.
# 
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License.  You may obtain
# a copy of the License at
# 
#         http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
# License for the specific language governing permissions and limitations
# under the License.
#
# Initial developer(s): Jeff Mace
# Contributor(s):

begin
  require 'rubygems'
  gem 'continuent-tools-core'
rescue LoadError
end

require 'continuent-tools-core'
require 'continuent-tools-nagios-monitor'

class ContinuentNagiosMonitorProgress
  include TungstenScript
  include TungstenNagiosMonitor
  private
  
  def main
    unless TI.is_replicator?()
      critical("The server is not a Tungsten Replicator")
    end
    
    unless TI.is_running?("replicator")
      critical("The Tungsten Replicator is not running")
    end
    
    if TI.is_commercial?()
      unless TI.is_manager?()
        critical("The server is not a Continuent Tungsten Manager")
      end

      unless TI.is_running?("manager")
        critical("The Continuent Tungsten Manager is not running")
      end
    end
    
    opt_default(:service, TI.default_dataservice())
    if opt(:service) == nil
      critical("The --service option was not given")
    end
    
    unless TI.trepctl_value(opt(:service), "state") == "ONLINE"
      critical("The #{opt(:service)} replication service is not ONLINE")
    end

    role=TI.trepctl_value(opt(:service), "role").to_s()

    if role == 'master'
      pre_binlog_to_q=TI.trepctl_name_value(opt(:service),'tasks', 'binlog-to-q',"appliedLastSeqno").to_s().to_f()
      pre_q_to_thl=TI.trepctl_name_value(opt(:service), 'tasks', 'q-to-thl',"appliedLastSeqno").to_s().to_f()
    end

    if role == 'slave' or role == 'relay'
      pre_remote_to_thl=TI.trepctl_name_value(opt(:service),'tasks', 'remote-to-thl',"appliedLastSeqno").to_s().to_f()
      pre_thl_to_q=TI.trepctl_name_value(opt(:service),'tasks', 'thl-to-q',"appliedLastSeqno").to_s().to_f()
      pre_q_to_dbms=TI.trepctl_name_value(opt(:service),'tasks', 'q-to-dbms',"appliedLastSeqno").to_s().to_f()
    end

    if TI.is_commercial?()
      TI.ensure_cctrl("cluster heartbeat")
    end

    if opt(:delay).is_a?(Integer)
      TU.debug("Go to sleep for #{opt(:delay)} seconds")
      sleep(opt(:delay))
    end

    replicator_making_progress=false
    if role == 'master'
      if TI.trepctl_name_value(opt(:service),'tasks', 'binlog-to-q',"appliedLastSeqno").to_s().to_f()-pre_binlog_to_q > 0
        replicator_making_progress=true
      end
      if TI.trepctl_name_value(opt(:service), 'tasks', 'q-to-thl',"appliedLastSeqno").to_s().to_f()-pre_q_to_thl > 0
        replicator_making_progress=true
      end
    end
    if role == 'slave' or role == 'relay'
      if TI.trepctl_name_value(opt(:service),'tasks', 'remote-to-thl',"appliedLastSeqno").to_s().to_f() - pre_remote_to_thl > 0
        replicator_making_progress=true
      end
      if TI.trepctl_name_value(opt(:service),'tasks', 'thl-to-q',"appliedLastSeqno").to_s().to_f() - pre_thl_to_q > 0
        replicator_making_progress=true
      end
      if TI.trepctl_name_value(opt(:service),'tasks', 'q-to-dbms',"appliedLastSeqno").to_s().to_f() - pre_q_to_dbms > 0
        replicator_making_progress=true
      end
    end


    if replicator_making_progress 
      ok("Tungsten Replicator #{opt(:service)} service is making progress")
    else
      critical("Tungsten Replicator #{opt(:service)} service did not show progress")
    end
  end
  
  def configure
    super()
    
    description("Check that the replication service is making progress. For Continuent Tungsten installations, a heartbeat command will be run to force activity.")
    
    add_option(:delay, {
      :on => "--delay String",
      :help => "The number of seconds to wait when monitoring progress",
      :parse => method(:parse_integer_option),
      :default => 1
    })
    
    add_option(:service, {
      :on => "--service String",
      :help => "The replication service or cluster to check"
    })
  end
  
  def script_name
    "tungsten_nagios_progress"
  end
  
  self.new().run()
end
